# Как работает BaseComponent

`BaseComponent` — это базовый класс для создания веб-компонентов, который упрощает работу с шаблонами, свойствами и рендерингом. Он наследуется от стандартного `HTMLElement` и предоставляет функционал для декларативного описания компонентов.

Файл: [BaseComponent.js](BaseComponent.js)

## 1. Регистрация компонента

Компоненты регистрируются через статический метод `registerWcc`.

*   [registerWcc](BaseComponent.js#L397):
    *   Проверяет имя класса (должно быть PascalCase).
    *   Генерирует имя тега в kebab-case (например, `MyComponent` -> `my-component`).
    *   Регистрирует компонент в `customElements`.
    *   Связывает тег с URL скрипта для автоматической загрузки.

## 2. Свойства и Атрибуты

`BaseComponent` обеспечивает автоматическую синхронизацию между JavaScript-свойствами и HTML-атрибутами.

*   [properties](BaseComponent.js#L49): Статический геттер, где описываются свойства, их типы и значения по умолчанию.
*   [_initProperties](BaseComponent.js#L69): Создает геттеры и сеттеры для свойств.
    *   При изменении свойства автоматически обновляется соответствующий атрибут (если указан `attribute` в конфиге).
    *   Вызывает `propertyChangedCallback`.
*   [attributeChangedCallback](BaseComponent.js#L156): Реагирует на изменение атрибутов в DOM и обновляет JS-свойства, приводя их к нужному типу (Number, Boolean).
*   [observedAttributes](BaseComponent.js#L37): Автоматически формирует список отслеживаемых атрибутов на основе `properties`.

## 3. Загрузка и Обработка Шаблонов

Компонент поддерживает загрузку HTML-шаблонов из отдельных файлов или использование статических строковых шаблонов.

*   [loadTemplate](BaseComponent.js#L209): Основной метод загрузки.
    *   Если определен `static get template`, использует его.
    *   Иначе загружает `.html` файл с тем же именем, что и компонент (через `fetch`).
    *   Кэширует загруженный шаблон в `_cachedHtml` для оптимизации повторного использования.
*   [_processTemplate](BaseComponent.js#L687):
    *   Извлекает содержимое `<style>` из шаблона.
    *   Объединяет стили и добавляет их в `<head>` документа (с уникальным ID), чтобы избежать дублирования.
    *   Возвращает "чистый" HTML без стилей для вставки в компонент.

## 4. Рендеринг и DOM

В отличие от Shadow DOM, `BaseComponent` работает в Light DOM (обычном DOM), но эмулирует поведение слотов.

*   [render](BaseComponent.js#L731):
    *   Создает временный контейнер с HTML шаблона.
    *   **Эмуляция слотов**:
        *   Сохраняет текущие дочерние элементы компонента (`fragment`).
        *   Находит элементы `<slot>` в шаблоне.
        *   Распределяет дочерние элементы по слотам (по атрибуту `slot="name"` или в дефолтный слот).
        *   Если слот пустой, отображает его содержимое по умолчанию.
    *   Заменяет содержимое компонента (`this.innerHTML`) на обработанный шаблон.
    *   Вызывает `_resolveImagePaths`.
*   [_resolveImagePaths](BaseComponent.js#L823): Преобразует относительные пути (`./`, `../`) в `src` атрибутах (например, `<img>`) в абсолютные, основываясь на URL скрипта компонента.

## 5. Динамика и Логика в Шаблонах

`BaseComponent` поддерживает простой синтаксис шаблонизации прямо в HTML.

*   **Интерполяция строк**:
    *   [evaluateString](BaseComponent.js#L612): Позволяет использовать выражения `${this.prop}` внутри `<!-- include -->` или при рендеринге списков.
*   **Условный рендеринг**:
    *   [_processConditionals](BaseComponent.js#L569): Обрабатывает блоки `<!-- if(this.show) --> ... <!-- endif -->`. Вычисляет условие и показывает или скрывает контент.
*   **Внутренние шаблоны (Списки)**:
    *   [_extractInnerTemplates](BaseComponent.js#L537): Извлекает блоки `<!-- innerTemplate:name -->`.
    *   [renderInnerTemplateList](BaseComponent.js#L621): Хелпер для рендеринга массивов данных, используя извлеченные шаблоны.

## 6. Жизненный цикл

*   [connectedCallback](BaseComponent.js#L13): Вызывается при добавлении в DOM. Инициирует загрузку шаблона (`loadTemplate`), если он еще не загружен.
*   [forceUpdate](BaseComponent.js#L305): Принудительно перерисовывает компонент (повторно обрабатывает условия и вставки).
*   [markLoaded](BaseComponent.js#L472): Статический метод для отслеживания загрузки скриптов компонентов (система зависимостей).

## 7. События

`BaseComponent` предоставляет удобные методы для генерации и обработки событий.

### Генерация событий (emit)

*   [emit(eventName, detail, options)](BaseComponent.js#L657): Создает и отправляет `CustomEvent`.
    *   `eventName` (string): Имя события.
    *   `detail` (any): Данные, передаваемые с событием (доступны через `event.detail`).
    *   `options` (object): Настройки события. По умолчанию `{ bubbles: true, composed: true }`, что позволяет событию всплывать вверх по DOM.

Пример использования внутри компонента:
```javascript
this.emit('my-event', { id: 123, status: 'ok' });
```

### Обработка событий (onRef)

Хотя можно использовать стандартный `addEventListener`, `BaseComponent` предлагает хелпер `onRef` для подписки на события элементов.

*   [onRef(refName, eventType, handler, options)](BaseComponent.js#L666):
    *   `refName`: Может быть строкой (ищет элемент в `this._refs`, если он определен в наследнике) или прямым DOM-элементом.
    *   `eventType`: Тип события (например, 'click').
    *   `handler`: Функция-обработчик.
    *   `options`: Опции для `addEventListener` (например, `{ once: true }`).

## 8. Адаптивность (Fluid Value)

Для реализации адаптивного дизайна через JS (когда CSS `clamp` или `calc` недостаточно гибки или нужны вычисления значений для JS-логики) предусмотрен метод `calculateFluidValue`.

*   [calculateFluidValue(minWidth, maxWidth, minVal, maxVal)](BaseComponent.js#L652):
    *   Вычисляет текущее значение на основе ширины окна (`window.innerWidth`) методом линейной интерполяции.
    *   Формула: `V = vMin + (W - wMin) * (vMax - vMin) / (wMax - wMin)`.
    *   Полезно для плавной анимации, изменения размеров canvas или других динамических параметров, зависящих от ширины экрана.

---
**Глобальный доступ**: Класс экспортируется как `export class`, но также присваивается в `window.BaseComponent` [L853](BaseComponent.js#L853), что делает его доступным глобально без явного импорта в скриптах, если он уже загружен.
